@inject GameStateService GameState
@implements IDisposable

<section class="history-panel">
    <h3>History</h3>
    @if (GameState.Moves.Count == 0)
    {
        <p>No moves yet.</p>
    }
    else
    {
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Player</th>
                    <th>Target</th>
                    <th>Result</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var move in GameState.Moves.OrderBy(m => m.MoveNumber))
                {
                    <tr>
                        <td>@move.MoveNumber</td>
                        <td>@GetPlayerLabel(move)</td>
                        <td>(@move.Target.X,@move.Target.Y)</td>
                        <td>@move.Result</td>
                        <td>@move.PlayedAt.ToLocalTime().ToString("HH:mm:ss")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</section>

@code {
    protected override void OnInitialized()
    {
        GameState.StateChanged += OnStateChanged;
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        GameState.StateChanged -= OnStateChanged;
    }

    private string GetPlayerLabel(MoveHistoryEntry move)
    {
        if (!GameState.IsMultiplayer)
        {
            return move.Player.ToString();
        }

        var isLocalMove = move.Slot == GameState.PlayerRole;
        return isLocalMove ? "You" : "Opponent";
    }
}

